function module(t,e,n){var r,o,i,s,a,c,l,u,f,m,g,d,h,v,p,D,C,k,w;n.link("@babel/runtime/regenerator",{default:function(t){r=t}},0),n.link("@babel/runtime/helpers/createForOfIteratorHelperLoose",{default:function(t){o=t}},1),n.link("moment-timezone"),n.link("underscore",{default:function(t){i=t}},0),n.link("moment",{default:function(t){s=t}},1),n.link("./livechatCurrentChats.css"),n.link("meteor/reactive-var",{ReactiveVar:function(t){a=t}},2),n.link("meteor/kadira:flow-router",{FlowRouter:function(t){c=t}},3),n.link("meteor/templating",{Template:function(t){l=t}},4),n.link("meteor/meteor",{Meteor:function(t){u=t}},5),n.link("meteor/random",{Random:function(t){f=t}},6),n.link("toastr",{default:function(t){m=t}},7),n.link("meteor/rocketchat:tap-i18n",{TAPi18n:function(t){g=t}},8),n.link("../../../../ui-utils",{modal:function(t){d=t},call:function(t){h=t},popover:function(t){v=t}},9),n.link("../../../../utils/client",{t:function(t){p=t},handleError:function(t){D=t},APIClient:function(t){C=t}},10),n.link("../../../../authorization",{hasRole:function(t){k=t},hasPermission:function(t){w=t}},11),n.link("./livechatCurrentChats.html");var y=50,F="Filters.LivechatCurrentChats",_=function(){var t;try{var e;t=u._localStorage.getItem(F)?JSON.parse(u._localStorage.getItem(F)):{}}catch(n){t={}}return t},A=function(t){u._localStorage.setItem(F,JSON.stringify(t))},T=function(){u._localStorage.removeItem(F)};l.livechatCurrentChats.helpers({hasMore:function(){var t=l.instance();return t.total.get()>t.livechatRooms.get().length},isLoading:function(){return l.instance().isLoading.get()},livechatRoom:function(){return l.instance().livechatRooms.get()},startedAt:function(){return s(this.ts).format("L LTS")},lastMessage:function(){return s(this.lm).format("L LTS")},servedBy:function(){return this.servedBy&&this.servedBy.username},status:function(){return this.open?p("Opened"):p("Closed")},isClosed:function(){return!this.open},onSelectAgents:function(){return l.instance().onSelectAgents},agentModifier:function(){return function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=t.get();return"@"+(0===n.length?e:e.replace(new RegExp(t.get()),(function(t){return"<strong>"+t+"</strong>"})))}},selectedAgents:function(){return l.instance().selectedAgents.get()},onClickTagAgent:function(){return l.instance().onClickTagAgent},customFilters:function(){return l.instance().customFilters.get()},tagFilters:function(){return l.instance().tagFilters.get()},tagId:function(){return this},departmentModifier:function(){return function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=t.get();return""+(0===n.length?e:e.replace(new RegExp(t.get(),"i"),(function(t){return"<strong>"+t+"</strong>"})))}},onClickTagDepartment:function(){return l.instance().onClickTagDepartment},selectedDepartments:function(){return l.instance().selectedDepartments.get()},onSelectDepartments:function(){return l.instance().onSelectDepartments},onTableSort:function(){var t=l.instance(),e=t.sortDirection,n=t.sortBy;return function(t){if(n.get()===t)return e.set("asc"===e.get()?"desc":"asc");n.set(t),e.set("asc")}},sortBy:function(t){return l.instance().sortBy.get()===t},sortIcon:function(t){var e=l.instance(),n=e.sortDirection,r;return t===e.sortBy.get()&&"asc"===n.get()?"sort-up":"sort-down"}}),l.livechatCurrentChats.events({"click .row-link":function(){c.go("live",{id:this._id})},"click .js-load-more":function(t,e){e.offset.set(e.offset.get()+y)},"click .add-filter-button":function(t,e){t.preventDefault();var n=e.customFields.get(),r=e.customFilters.get(),i=e.tagFilters.get(),s=[];s.push({name:p("Tags"),action:function(){i.push(f.id()),e.tagFilters.set(i)}});for(var a=function(t){return"visible"!==t.visibility?"continue":"room"!==t.scope?"continue":r.find((function(e){return e.name===t._id}))?"continue":void s.push({name:t.label,action:function(){r.push({_id:t._id,name:t._id,label:t.label}),e.customFilters.set(r)}})},c=o(n),l;!(l=c()).done;)var u,m=a(l.value);var g={popoverClass:"livechat-current-chats-add-filter",columns:[{groups:[{items:s}]}],currentTarget:t.currentTarget,offsetVertical:t.currentTarget.clientHeight};v.open(g)},"click .livechat-current-chats-extra-actions":function(t,e){t.preventDefault(),t.stopPropagation();var n=t.currentTarget,r=w("remove-closed-livechat-rooms"),o=function(){if(!k(u.userId(),["admin","livechat-manager"])){var t=e.departments.get();return t&&t.map((function(t){return t._id}))}},i={popoverClass:"livechat-current-chats-add-filter",columns:[{groups:[{items:[{icon:"customize",name:p("Clear_filters"),action:e.clearFilters},r&&{icon:"trash",name:p("Delete_all_closed_chats"),modifier:"alert",action:function(){d.open({title:p("Are_you_sure"),type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:p("Yes"),cancelButtonText:p("Cancel"),closeOnConfirm:!0,html:!1},(function(){u.call("livechat:removeAllClosedRooms",o(),(function(t,n){if(t)return D(t);n&&(e.loadRooms(e.filter.get(),e.offset.get()),m.success(g.__("All_closed_chats_have_been_removed")))}))}))}}]}]}],currentTarget:n,offsetVertical:n.clientHeight};v.open(i)},"click .remove-livechat-tags-filter":function(t,e){t.preventDefault();var n=t.currentTarget.dataset.id,r=e.tagFilters.get(),o=r.indexOf(n);o>=0&&r.splice(o,1),e.tagFilters.set(r)},"click .remove-livechat-custom-filter":function(t,e){t.preventDefault();var n=t.currentTarget.dataset.name,r=e.customFilters.get(),o=r.findIndex((function(t){return t.name===n}));o>=0&&r.splice(o,1),e.customFilters.set(r)},"submit form":function(t,e){t.preventDefault();var n={};$(":input",t.currentTarget).each((function(){if(this.name){var t=$(this).val();if(t)return this.name.startsWith("custom-field-")?(n.customFields||(n.customFields={}),void(n.customFields[this.name.replace("custom-field-","")]=t)):"tags"===this.name?(n.tags||(n.tags=[]),void(t&&n.tags.push(t))):void(n[this.name]=t)}})),i.isEmpty(n.from)?delete n.from:n.from=s(n.from,s.localeData().longDateFormat("L")).toDate(),i.isEmpty(n.to)?delete n.to:n.to=s(n.to,s.localeData().longDateFormat("L")).toDate();var r=e.selectedAgents.get();r&&r.length>0&&(n.agents=[r[0]]);var o=e.selectedDepartments.get();o&&o.length>0&&(n.department=[o[0]]),e.filter.set(n),e.offset.set(0),A(n)},"click .remove-livechat-room":function(t,e){var n=this;t.preventDefault(),t.stopPropagation(),d.open({title:p("Are_you_sure"),type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:p("Yes"),cancelButtonText:p("Cancel"),closeOnConfirm:!1,html:!1},function(){function t(t){return r.async(function(){function o(o){for(;;)switch(o.prev=o.next){case 0:if(t){o.next=2;break}return o.abrupt("return");case 2:return o.next=4,r.awrap(h("livechat:removeRoom",n._id));case 4:e.loadRooms(e.filter.get(),e.offset.get()),d.open({title:p("Deleted"),text:p("Room_has_been_deleted"),type:"success",timer:1e3,showConfirmButton:!1});case 6:case"end":return o.stop()}}return o}(),null,null,null,Promise)}return t}())},"input [id=agent]":function(t,e){var n;""===t.currentTarget.value&&e.selectedAgents.set([])}}),l.livechatCurrentChats.onCreated(function(){function t(){var t=this,e,n;return r.async(function(){function o(o){for(;;)switch(o.prev=o.next){case 0:this.isLoading=new a(!1),this.offset=new a(0),this.total=new a(0),this.filter=new a(_()),this.livechatRooms=new a([]),this.selectedAgents=new a([]),this.customFilters=new a([]),this.customFields=new a([]),this.tagFilters=new a([]),this.selectedDepartments=new a([]),this.sortBy=new a("ts"),this.sortDirection=new a("desc"),this.onSelectDepartments=function(e){var n=e.item;n.text=n.name,t.selectedDepartments.set([n])},this.onClickTagDepartment=function(){t.selectedDepartments.set([])},e=function(t,e,n){return e.reduce((function(r,o){var i=n===e.length-1;return r+=t+"[]="+o+(i?"":"&")}),"")},n=function(t,n,r){var o=t.status,i=t.agents,a=t.department,c=t.from,l=t.to,u=t.tags,f=t.customFields,m=t.name,g="livechat/rooms?count="+y+"&offset="+n+"&sort="+JSON.stringify(r),d={};return o&&(g+="&open="+("opened"===o)),a&&Array.isArray(a)&&a.length&&(g+="&departmentId="+a[0]._id),c&&(d.start=s(new Date(c)).utc().format("YYYY-MM-DDTHH:mm:ss")+"Z"),l&&(d.end=s(new Date(l).setHours(23,59,59)).utc().format("YYYY-MM-DDTHH:mm:ss")+"Z"),u&&(g+="&"+e("tags",u)),i&&Array.isArray(i)&&i.length&&(g+="&"+e("agents",i.map((function(t){return t._id})))),f&&(g+="&customFields="+JSON.stringify(f)),Object.keys(d).length&&(g+="&createdAt="+JSON.stringify(d)),m&&(g+="&roomName="+m),g},this.loadDefaultFilters=function(){var e=t.filter.get();Object.keys(e).forEach((function(n){var r=e[n];if(r){switch(n){case"agents":return t.selectedAgents.set(r);case"department":return t.selectedDepartments.set(r);case"from":case"to":return $("#"+n).datepicker("setDate",new Date(r))}$("#"+n).val(r)}}))},this.clearFilters=function(){T(),$("#form-filters").get(0).reset(),t.selectedAgents.set([]),t.selectedDepartments.set([]),t.filter.set({})},this.loadRooms=function(){function e(e,o,i){var s,a,c;return r.async(function(){function l(l){for(;;)switch(l.prev=l.next){case 0:return t.isLoading.set(!0),l.next=3,r.awrap(C.v1.get(n(e,o,i)));case 3:s=l.sent,a=s.rooms,c=s.total,t.total.set(c),0===o?t.livechatRooms.set(a):t.livechatRooms.set(t.livechatRooms.get().concat(a)),t.isLoading.set(!1);case 9:case"end":return l.stop()}}return l}(),null,null,null,Promise)}return e}(),this.onSelectAgents=function(e){var n=e.item;t.selectedAgents.set([n])},this.onClickTagAgent=function(e){var n=e.username;t.selectedAgents.set(t.selectedAgents.get().filter((function(t){return t.username!==n})))},this.autorun(function(){function e(){var e,n,o,i,s,a;return r.async(function(){function r(r){for(;;)switch(r.prev=r.next){case 0:n=t.filter.get(),o=t.offset.get(),i=l.instance(),s=i.sortDirection,a=i.sortBy,t.loadRooms(n,o,((e={})[a.get()]="asc"===s.get()?1:-1,e));case 4:case"end":return r.stop()}}return r}(),null,null,null,Promise)}return e}()),u.call("livechat:getCustomFields",(function(e,n){n&&t.customFields.set(n)}));case 23:case"end":return o.stop()}}return o}(),null,this,null,Promise)}return t}()),l.livechatCurrentChats.onRendered((function(){this.$(".input-daterange").datepicker({autoclose:!0,todayHighlight:!0,format:s.localeData().longDateFormat("L").toLowerCase()}),this.loadDefaultFilters()}))}

