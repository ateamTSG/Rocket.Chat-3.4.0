function module(e,n,t){var a,r,i,s,o,l,c,u,g,f,m,h,d,v,p,C,T,b;t.link("@babel/runtime/helpers/objectSpread2",{default:function(e){a=e}},0),t.link("@babel/runtime/regenerator",{default:function(e){r=e}},1),t.link("@babel/runtime/helpers/slicedToArray",{default:function(e){i=e}},2),t.link("@babel/runtime/helpers/toConsumableArray",{default:function(e){s=e}},3),t.link("meteor/meteor",{Meteor:function(e){o=e}},0),t.link("meteor/reactive-var",{ReactiveVar:function(e){l=e}},1),t.link("meteor/kadira:flow-router",{FlowRouter:function(e){c=e}},2),t.link("meteor/templating",{Template:function(e){u=e}},3),t.link("underscore",{default:function(e){g=e}},4),t.link("toastr",{default:function(e){f=e}},5),t.link("../../../../ui-utils",{TabBar:function(e){m=e},RocketChatTabBar:function(e){h=e}},6),t.link("../../../../utils",{t:function(e){d=e},handleError:function(e){v=e}},7),t.link("../../../../authorization",{hasPermission:function(e){p=e}},8),t.link("./customTemplates/register",{getCustomFormTemplate:function(e){C=e}},9),t.link("./livechatDepartmentForm.html"),t.link("../../../../utils/client",{APIClient:function(e){T=e},roomTypes:function(e){b=e}},10),u.livechatDepartmentForm.helpers({department:function(){return u.instance().department.get()},agents:function(){return u.instance().department&&!g.isEmpty(u.instance().department.get())?u.instance().department.get().agents:[]},departmentAgents:function(){return g.sortBy(u.instance().departmentAgents.get(),"username")},showOnRegistration:function(e){var n=u.instance().department.get();return n.showOnRegistration===e||void 0===n.showOnRegistration&&!0===e},showOnOfflineForm:function(e){var n=u.instance().department.get();return n.showOnOfflineForm===e||void 0===n.showOnOfflineForm&&!0===e},requestTagBeforeClosingChat:function(){var e=u.instance().department.get();return!(!e||!e.requestTagBeforeClosingChat)},customFieldsTemplate:function(){return C("livechatDepartmentForm")},data:function(){return{id:c.getParam("_id")}},exceptionsAgents:function(){return g.pluck(u.instance().departmentAgents.get(),"username")},agentModifier:function(){return function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",t=e.get();return"@"+(0===t.length?n:n.replace(new RegExp(e.get()),(function(e){return"<strong>"+e+"</strong>"})))}},agentConditions:function(){return{roles:"livechat-agent"}},onSelectAgents:function(){return u.instance().onSelectAgents},selectedAgents:function(){return u.instance().selectedAgents.get()},onClickTagAgents:function(){return u.instance().onClickTagAgents},flexData:function(){return{tabBar:u.instance().tabBar,data:u.instance().tabBarData.get()}},tabBarVisible:function(){return Object.values(m.buttons.get()).some((function(e){return e.groups.some((function(e){return e.startsWith("livechat-department")}))}))},chatClosingTags:function(){return u.instance().chatClosingTags.get()},availableDepartmentTags:function(){return u.instance().availableDepartmentTags.get()},hasAvailableTags:function(){return s(u.instance().availableTags.get()).length>0},hasChatClosingTags:function(){return s(u.instance().chatClosingTags.get()).length>0},onClickTagOfflineMessageChannel:function(){return u.instance().onClickTagOfflineMessageChannel},selectedOfflineMessageChannel:function(){return u.instance().offlineMessageChannel.get()},onSelectOfflineMessageChannel:function(){return u.instance().onSelectOfflineMessageChannel},offlineMessageChannelModifier:function(){return function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",t=e.get();return"#"+(0===t.length?n:n.replace(new RegExp(e.get()),(function(e){return"<strong>"+e+"</strong>"})))}},channelSelector:function(){return function(e){return{name:e}}}}),u.livechatDepartmentForm.events({"submit #department-form":function(e,n){e.preventDefault();var t=n.$("button.save"),a,r=$(e.currentTarget).data("id");if(p("manage-livechat-departments")){var s=n.$("input[name=enabled]:checked").val(),l=n.$("input[name=name]").val(),u=n.$("textarea[name=description]").val(),g=n.$("input[name=showOnRegistration]:checked").val(),m=n.$("input[name=email]").val(),h=n.$("input[name=showOnOfflineForm]:checked").val(),C=n.$("input[name=requestTagBeforeClosingChat]:checked").val(),T=n.chatClosingTags.get(),k=n.offlineMessageChannel.get(),w,A=i(k,1)[0],O=A&&b.getRoomName(A.t,A)||"";if("1"!==s&&"0"!==s)return f.error(d("Please_select_enabled_yes_or_no"));if(""===l.trim())return f.error(d("Please_fill_a_name"));if(""===m.trim()&&"1"===h)return f.error(d("Please_fill_an_email"));a={enabled:"1"===s,name:l.trim(),description:u.trim(),showOnRegistration:"1"===g,showOnOfflineForm:"1"===h,requestTagBeforeClosingChat:"1"===C,email:m.trim(),chatClosingTags:T,offlineMessageChannelName:O}}var _=t.html();t.html(d("Saving")),n.$(".customFormField").each((function(e,t){var r=n.$(t),i=r.attr("name");a[i]=r.val()}));var x=[];n.departmentAgents.get().forEach((function(e){e.count=n.$(".count-"+e.agentId).val(),e.order=n.$(".order-"+e.agentId).val(),x.push(e)}));var D=function(e){if(t.html(_),e)return v(e);f.success(d("Saved")),c.go("livechat-departments")};if(p("manage-livechat-departments"))o.call("livechat:saveDepartment",r,a,x,D);else{if(!p("add-livechat-department-agents"))throw new Error(d("error-not-authorized"));o.call("livechat:saveDepartmentAgents",r,x,D)}},"click .add-agent":function(e,n){var t;e.preventDefault(),n.selectedAgents.get().forEach(function(){function e(e){var t,a,i,s;return r.async(function(){function r(r){for(;;)switch(r.prev=r.next){case 0:if(t=e._id,a=e.username,!(i=n.departmentAgents.get()).find((function(e){var n;return e.agentId===t}))){r.next=4;break}return r.abrupt("return",f.error(d("This_agent_was_already_selected")));case 4:(s=g.clone(e)).agentId=t,delete s._id,i.push(s),n.departmentAgents.set(i),n.selectedAgents.set(n.selectedAgents.get().filter((function(e){return e.username!==a})));case 10:case"end":return r.stop()}}return r}(),null,null,null,Promise)}return e}())},"click button.back":function(e){e.preventDefault(),c.go("livechat-departments")},"click .remove-agent":function(e,n){var t=this;e.preventDefault(),n.departmentAgents.set(n.departmentAgents.get().filter((function(e){return e.agentId!==t.agentId})))},"click #addTag":function(e,n){e.stopPropagation(),e.preventDefault();var t=s(n.availableTags.get()).length>0,a=t?"#tagSelect":"#tagInput",r=t?"placeholder":"",i=$(a).val(),o=s(n.chatClosingTags.get());""===i||o.indexOf(i)>-1||(o.push(i),n.chatClosingTags.set(o),$(a).val(r))},"click .remove-tag":function(e,n){var t=this;e.stopPropagation(),e.preventDefault();var a=s(n.chatClosingTags.get()).filter((function(e){return e!==t.valueOf()}));n.chatClosingTags.set(a)}}),u.livechatDepartmentForm.onCreated(function(){function e(){var e=this;return r.async(function(){function n(n){for(;;)switch(n.prev=n.next){case 0:this.department=new l({enabled:!0}),this.departmentAgents=new l([]),this.selectedAgents=new l([]),this.tabBar=new h,this.tabBar.showGroup(c.current().route.name),this.tabBarData=new l,this.chatClosingTags=new l([]),this.availableTags=new l([]),this.availableDepartmentTags=new l([]),this.offlineMessageChannel=new l([]),this.onClickTagOfflineMessageChannel=function(){e.offlineMessageChannel.set([])},this.onSelectOfflineMessageChannel=function(){function n(n){var t,a,i;return r.async(function(){function s(s){for(;;)switch(s.prev=s.next){case 0:return t=n.item,s.next=3,r.awrap(T.v1.get("rooms.info?roomId="+t._id));case 3:a=s.sent,(i=a.room).text=i.name,e.offlineMessageChannel.set([i]);case 7:case"end":return s.stop()}}return s}(),null,null,null,Promise)}return n}(),this.onSelectAgents=function(n){var t=n.item;e.selectedAgents.set([t])},this.onClickTagAgents=function(n){var t=n.username;e.selectedAgents.set(e.selectedAgents.get().filter((function(e){return e.username!==t})))},this.loadAvailableTags=function(n){o.call("livechat:getTagsList",(function(t,a){e.availableTags.set(a||[]);var r,i=e.availableTags.get().filter((function(e){var t=e.departments;return 0===t.length||t.indexOf(n)>-1})).map((function(e){var n;return e.name}));e.availableDepartmentTags.set(i)}))},this.autorun(function(){function n(){var n,t,a,i,s;return r.async(function(){function o(o){for(;;)switch(o.prev=o.next){case 0:if(!(n=c.getParam("_id"))){o.next=12;break}return o.next=4,r.awrap(T.v1.get("livechat/department/"+c.getParam("_id")));case 4:t=o.sent,a=t.department,i=t.agents,s=void 0===i?[]:i,e.department.set(a),e.departmentAgents.set(s),e.chatClosingTags.set(a&&a.chatClosingTags||[]),e.loadAvailableTags(n);case 12:case"end":return o.stop()}}return o}(),null,null,null,Promise)}return n}()),this.autorun(function(){function n(){var n,t,i,s;return r.async(function(){function o(o){for(;;)switch(o.prev=o.next){case 0:if(n=e.department.get(),t=[],!(null==n?void 0:n.offlineMessageChannelName)){o.next=8;break}return o.next=5,r.awrap(T.v1.get("rooms.info?roomName="+(null==n?void 0:n.offlineMessageChannelName)));case 5:i=o.sent,(s=i.room)&&(s.text=s.name,t=[a({},s)]);case 8:e.offlineMessageChannel.set(t);case 9:case"end":return o.stop()}}return o}(),null,null,null,Promise)}return n}());case 17:case"end":return n.stop()}}return n}(),null,this,null,Promise)}return e}())}

